#!/bin/bash
#19/12/2023

tput clear

### MENU
pag () {
tput clear
echo -e "\033[01;33m[1;32m            MENU WS-EPRO        \033[1;33m \033[0m"
echo -e
echo -e "\033[01;33m[1;32m [1] \033[1;33mATIVAR WS-EPRO CLOUDFLARE \033[0m"
echo -e "\033[01;33m[1;32m [2] \033[1;33mMODIFICAR PORTA WS-EPRO \033[0m"
echo -e "\033[01;33m[1;32m [3] \033[1;33mDESATIVAR WS-EPRO \033[0m"
echo -e
echo -e "\033[01;33m[1;32m [0]\033[1;33mSAIR DOS PROTOCOLOS \033[0m"
echo -e
read -p " SELECIONE UMA OPÇÃO : " opci
case $opci in

#opcion 1
1)
tput clear
pres_adm
echo
echo -e "\e[33m     >>> \e[1;32mINSTALANDO SERVIDOR PYTHON WS-EPRO \e[33m<<<\e[0m"
sleep 0.3
echo
cd

#Install ws-epro
wget -q --show-progress --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=1IbwfNpKpa1JzvXsDT-WgNpp5nWrklisG' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=1IbwfNpKpa1JzvXsDT-WgNpp5nWrklisG" -O /usr/local/bin/ws-epro && rm -rf /tmp/cookies.txt
chmod +x /usr/local/bin/ws-epro

#ws-epro service
wget -q --show-progress --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=10hGKYNZUMHdr4y-ZxMr0wKQpj9zSQRkZ' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=10hGKYNZUMHdr4y-ZxMr0wKQpj9zSQRkZ" -O /etc/systemd/system/ws-epro.service && rm -rf /tmp/cookies.txt
chmod +x /etc/systemd/system/ws-epro.service

#ws-epro port
wget -q --show-progress --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=1h9QvOnXScplGTnfpbJ7KJDn4CDkwUKWa' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=1h9QvOnXScplGTnfpbJ7KJDn4CDkwUKWa" -O /usr/bin/ws-port && rm -rf /tmp/cookies.txt
chmod +x /usr/bin/ws-port

#seting port
#clear
#pres_adm
msg -bar
echo
echo -e "\e[1;97m >>>  SELEÇÃO DE PORTAS  <<< \e[0m"
echo
read -p " ✓ PORTA PARA PHYTON : " wsopenssh
echo
read -p " ✓ PORTA LOCAL (ssh|ssl|openvpn): " openssh
WS_DIR=/usr/local/etc/ws-epro
if [ -d "$WS_DIR" ]; then # if it exists,delete it.
    rm -rf "$WS_DIR"
fi
sleep 0.3
mkdir "$WS_DIR"
echo
msg -bar
echo
echo -e "\e[1;33m   CONFIGURANDO SERVIDOR ESPERE... \e[0m"
sleep 0.5
echo "# verbose level 0=info, 1=verbose, 2=very verbose" >> /usr/local/etc/ws-epro/config.yml
echo "verbose: 0" >> /usr/local/etc/ws-epro/config.yml
echo "listen:"  >> /usr/local/etc/ws-epro/config.yml

#seting port
echo "##openssh" >> /usr/local/etc/ws-epro/config.yml
echo "- target_host: 127.0.0.1" >> /usr/local/etc/ws-epro/config.yml
echo "##portopenssh" >> /usr/local/etc/ws-epro/config.yml
echo "  target_port: $openssh" >> /usr/local/etc/ws-epro/config.yml
echo "##wsopenssh" >> /usr/local/etc/ws-epro/config.yml
echo "  listen_port: $wsopenssh" >> /usr/local/etc/ws-epro/config.yml

chmod +x /usr/local/etc/ws-epro/config.yml

systemctl enable ws-epro
systemctl start ws-epro

sleep 0.3
tput clear
pres_adm
echo
echo -e "\e[1;97m          INSTALADO WS-EPRO (TURBONET-PRO) \e[0m"
echo -e "\e[1;33m          PORTAS UTILIZADAS PARA CONEXÃO: \e[0m"
echo -e "\e[33m          ╔═══════════════════════╗\e[0m"
echo -e "\e[33m             Puerto Local SSH: \e[1;32m$openssh\e[0m"
echo -e "\e[33m             Puerto Phyton: \e[1;32m$wsopenssh\e[0m"
echo -e "\e[33m          ╚═══════════════════════╝\e[0m"
echo
msg -bar

#####
rm -rf install-ws && cat /dev/null > ~/.bash_history && history -c
msg -ne "Enter Para Continuar" && read enter
pag
;;

#opcion 2
2)
ws-port && msg -ne "Enter Para Continuar" && read enter
pag
;;                                

#opcion 3
3)
pkill -f ws-epro
WS_DIR=/usr/local/etc/ws-epro
if [ -d "$WS_DIR" ]; then # if it exists,delete it.
    rm -rf "$WS_DIR"
fi
echo
echo -e "\e[1;33m.  >>> PROTOCOLO WS-EPRO DESATIVADO... <<< \e[0m"
msg -bar
msg -ne "Enter Para Continuar" && read enter
menu_inst
;;

#opcion salir
0)
return 0
;;

esac
}

pag
